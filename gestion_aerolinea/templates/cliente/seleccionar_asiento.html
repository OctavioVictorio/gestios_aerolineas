{% extends 'base.html' %}
{% load static %}

{% block title %}Seleccionar Asientos{% endblock %}

{% block content %}
<a href="{% url 'detalles_vuelo' vuelo_id=vuelo.id %}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-2"></i> Volver a Detalles
</a>
<div class="container py-5" data-total-pasajeros="{{ total_pasajeros|default:0 }}">
    <div class="text-center mb-5">
        <h1 class="display-6 fw-bold text-primary">Seleccionar Asientos</h1>
        <p class="lead text-muted mt-2">Vuelo de <span class="fw-bold">{{ vuelo.origen }}</span> a <span class="fw-bold">{{ vuelo.destino }}</span></p>
    </div>

    <div class="card shadow-lg p-5 mx-auto" style="max-width: 800px;">
        <h5 class="text-center text-muted mb-4">Mapa de Asientos del Avión</h5>
        <div class="avion-layout text-center">
            <div class="bg-light p-3 rounded shadow-sm">
                <div class="bg-dark text-white p-2 rounded-top mb-3">
                    <i class="bi bi-airplane-engines-fill me-2"></i> Cabina
                </div>
                {% for fila, asientos_en_fila in layout_asientos.items %}
                    <div class="d-flex justify-content-center mb-2">
                        <div class="me-3 fw-bold">{{ fila }}</div>
                        {% for asiento in asientos_en_fila %}
                            {% if asiento %}
                                {% if asiento.id in asientos_reservados_ids %}
                                    <button type="button" class="btn btn-sm btn-secondary mx-1" disabled>
                                        {{ asiento.columna }}
                                    </button>
                                {% else %}
                                    <button type="button" 
                                            class="btn btn-sm btn-success mx-1 asiento-disponible" 
                                            data-asiento-id="{{ asiento.id }}" 
                                            data-asiento-numero="{{ asiento.numero }}">
                                        {{ asiento.columna }}
                                    </button>
                                {% endif %}
                            {% else %}
                                <div class="btn btn-sm mx-1 invisible"></div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="legend text-center mt-4 mb-5">
            <span class="badge bg-success p-2 mx-2"><i class="bi bi-chair"></i> Disponible</span>
            <span class="badge bg-secondary p-2 mx-2"><i class="bi bi-x-lg"></i> No Disponible</span>
            <span class="badge bg-primary p-2 mx-2"><i class="bi bi-check-lg"></i> Seleccionado</span>
        </div>
        
        <form id="reservaForm" action="{% url 'seleccionar_asiento' vuelo_id=vuelo.id %}" method="post" class="mt-4" novalidate>
            {% csrf_token %}
            <div id="asientos-pasajeros-container">
                </div>
            
            <button type="submit" id="submitBtn" class="btn btn-primary w-100 mt-3" disabled>
                <i class="bi bi-bookmark-plus-fill me-2"></i> Reservar Asientos
            </button>
        </form>

        <div class="mt-4 text-center">
            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#crearPasajeroModal">
                <i class="bi bi-person-plus-fill me-2"></i> Añadir Pasajero
            </button>
        </div>
    </div>
</div>

<div class="modal fade" id="crearPasajeroModal" tabindex="-1" aria-labelledby="crearPasajeroModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="crearPasajeroModalLabel">Añadir Pasajero</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% include 'cliente/form_pasajero.html' with form=pasajero_form %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="submit" form="pasajeroForm" class="btn btn-success">Guardar Pasajero</button>
            </div>
        </div>
    </div>
</div>

<style>
    .avion-layout .btn {
        width: 38px;
        height: 38px;
        border-radius: 8px;
        font-size: 0.85rem;
        padding: 0;
        line-height: 38px;
        text-align: center;
        background-color: #dee2e6;
        border: none;
    }
    .avion-layout .btn-success {
        background-color: #28a745;
        color: white;
    }
    .avion-layout .btn-success:hover {
        background-color: #218838;
    }
    .avion-layout .btn-secondary {
        background-color: #6c757d;
        color: white;
        cursor: not-allowed;
    }
    .avion-layout .btn-primary {
        background-color: #007bff;
        color: white;
    }
    .avion-layout .invisible {
        visibility: hidden;
    }
</style>

<script>
    const asientos = document.querySelectorAll('.asiento-disponible');
    const submitBtn = document.getElementById('submitBtn');
    const asientosPasajerosContainer = document.getElementById('asientos-pasajeros-container');
    
    let asientosSeleccionados = [];
    
    const mainContainer = document.querySelector('.container.py-5');
    const totalPasajeros = parseInt(mainContainer.dataset.totalPasajeros);

    if (totalPasajeros === 0) {
        window.location.href = "{% url 'detalles_vuelo' vuelo.id %}";
    }

    const updateFormUI = () => {
        asientosPasajerosContainer.innerHTML = '';
        if (asientosSeleccionados.length > 0) {
            asientosSeleccionados.forEach((asiento, index) => {
                const div = document.createElement('div');
                div.classList.add('mb-3', 'd-flex', 'align-items-center', 'gap-3');
                div.innerHTML = `
                    <h6 class="mb-0">Asiento ${asiento.dataset.asientoNumero}:</h6>
                    <select name="pasajeros" class="form-control" required>
                        <option value="" disabled selected>Selecciona un pasajero</option>
                        {% for pasajero in pasajeros %}
                            <option value="{{ pasajero.id }}">{{ pasajero.nombre }} {{ pasajero.apellido }}</option>
                        {% endfor %}
                    </select>
                    <input type="hidden" name="asientos" value="${asiento.dataset.asientoId}">
                `;
                asientosPasajerosContainer.appendChild(div);
            });
        }
        checkFormValidity();
    };

    const checkFormValidity = () => {
        const selects = asientosPasajerosContainer.querySelectorAll('select');
        const todosLlenos = asientosSeleccionados.length === totalPasajeros && Array.from(selects).every(select => select.value !== '');
        submitBtn.disabled = !todosLlenos;
    };
    
    asientos.forEach(asiento => {
        asiento.addEventListener('click', (e) => {
            e.preventDefault();
            const asientoId = asiento.dataset.asientoId;
            const asientoNumero = asiento.dataset.asientoNumero;
            
            if (asiento.classList.contains('asiento-seleccionado')) {
                asiento.classList.remove('asiento-seleccionado', 'btn-primary');
                asiento.classList.add('btn-success');
                asientosSeleccionados = asientosSeleccionados.filter(a => a.dataset.asientoId !== asientoId);
            } else {
                if (asientosSeleccionados.length < totalPasajeros) {
                    asiento.classList.add('asiento-seleccionado', 'btn-primary');
                    asiento.classList.remove('btn-success');
                    asientosSeleccionados.push(asiento);
                } else {
                    alert(`Ya seleccionaste ${totalPasajeros} asientos.`);
                }
            }
            updateFormUI();
        });
    });

    asientosPasajerosContainer.addEventListener('change', (e) => {
        if (e.target.tagName === 'SELECT') {
            checkFormValidity();
        }
    });

    checkFormValidity();
</script>
{% endblock %}